<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <script src="node_modules/tinymce/tinymce.min.js"></script>
<!--    Need to install JWT -->
<!--    <script src="https://cdn.tiny.cloud/1/fih9yz41sx4d68rduq22jqut1b3uzqgh6kcqc3p9rbjjro5r/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>-->

    <script>
        function example_image_upload_handler (blobInfo, success, failure, progress) {
            var xhr, formData;

            xhr = new XMLHttpRequest();
            xhr.withCredentials = false;
            xhr.open('POST', 'postAcceptor.php');

            xhr.upload.onprogress = function (e) {
                progress(e.loaded / e.total * 100);
            };

            xhr.onload = function() {
                var json;
                console.log(xhr)
                if (xhr.status === 403) {
                    failure('HTTP Error: ' + xhr.status, { remove: true });
                    return;
                }

                if (xhr.status < 200 || xhr.status >= 300) {
                    failure('HTTP Error: ' + xhr.status);
                    return;
                }

                json = JSON.parse(xhr.responseText);


                if (!json || typeof json.location != 'string') {
                    failure('Invalid JSON: ' + xhr.responseText);
                    return;
                }

                success(json.location);
            };

            xhr.onerror = function () {
                failure('Image upload failed due to a XHR Transport error. Code: ' + xhr.status);
            };

            formData = new FormData();
            formData.append('file', blobInfo.blob(), blobInfo.filename());

            xhr.send(formData);
        };

        tinymce.init({
            selector: '#mytextarea',
            height: 500,
            plugins: [
                'advlist anchor autolink autosave charmap codesample code directionality fullscreen',
                'help hr image imagetools importcss insertdatetime lists link media',
                'nonbreaking noneditable pagebreak paste print preview quickbars save searchreplace',
                'table tinydrive template textpattern toc visualblocks visualchars wordcount'
            ],
            // Image handlers
            imagetools_toolbar: 'rotateleft rotateright | flipv fliph | editimage imageoptions',
            automatic_uploads: true,
            images_dataimg_filter: function(img) {
                console.log('me ejecuto')
                return img.size <= 100; // blocks the upload of <img> elements with the attribute "internal-blob".
            },
            images_upload_handler: example_image_upload_handler,
            file_picker_types: 'image',
            // Image picker
            file_picker_callback: function (cb) {
                let input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');
                input.onchange = function () {
                    let file = this.files[0];
                    let size = this.files[0].size;
                    console.log(file)

                    if (size > 100000000) {
                        let message = document.createElement("span");
                        message.appendChild(document.createTextNode("File exceeds 1 MB"));
                        let sourceInput = document.getElementsByClassName('tox-form')[0].childNodes[0];
                        sourceInput.id = "sourceLargeImage";
                        sourceInput.appendChild(message);
                    } else {
                        let reader = new FileReader();
                        reader.onload = function () {
                            let id = 'blobid' + (new Date()).getTime();
                            let blobCache = tinymce.activeEditor.editorUpload.blobCache;
                            let base64 = reader.result.split(',')[1];
                            let blobInfo = blobCache.create(id, file, base64);
                            blobCache.add(blobInfo);
                            cb(blobInfo.blobUri(), {title: file.name});
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            },

            menubar: 'file edit insert format tools table help developer',
            menu: {
                file: {title: 'File', items: 'newdocument | print'},
                edit: {title: 'Edit', items: 'undo redo | cut copy pastetext | selectall | searchreplace'},
                insert: {
                    title: 'Insert',
                    items: 'image link media template inserttable | charmap hr | pagebreak nonbreaking anchor toc | insertdatetime'
                },
                format: {
                    title: 'Format',
                    items: 'bold italic underline strikethrough superscript subscript codeformat | formats blockformats fontformats fontsizes align lineheight | forecolor backcolor | removeformat'
                },
                tools: {title: 'Tools', items: 'spellchecker spellcheckerlanguage | code wordcount'},
                table: {title: 'Table', items: 'inserttable | cell row column | tableprops deletetable'},
                help: {title: 'Help', items: 'help'},
                developer: {title: 'Developer', items: 'code | visualblocks'}
            },
            toolbar: 'preview | ' +
                'image | ' +
                'undo redo | formatselect | ' +
                'bold italic backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
        });
    </script>
    <title>Customize TinyEMC</title>


</head>

<body>
<div class="container">
    <style>
        #sourceLargeImage {
            color: red;
            font-size: small;
        }
    </style>

    <h1>TinyMCE</h1>
    <form method="post">
        <textarea id="mytextarea">Escribe algo...</textarea>
    </form>
</div>

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

</body>
</html>
